# pages/3_Dashboard_Arquitetura.py

import streamlit as st
import pandas as pd
import plotly.express as px
from utils.ui import section # Reutiliza sua fun√ß√£o de t√≠tulo

st.set_page_config(page_title="Dashboard Arquitetura", layout="wide")

# URL RAW do arquivo (Tenta carregar o arquivo real)
FILE_URL = "https://raw.githubusercontent.com/alexandrejs13/job_architecture/main/data/Job%20Profile.xlsx"

# --- 1. FUN√á√ÉO DE CARREGAMENTO DE DADOS ---
@st.cache_data
def load_data(url):
    """Carrega o arquivo Job Profile.xlsx. Adicione tratamento de erro se o link falhar."""
    try:
        # Nota: Pandas pode ter problemas ao ler Excel de URLs HTTPS diretamente sem engine espec√≠fico
        # Caso o acesso falhe, mude para carregar um arquivo local (ex: pd.read_excel("data/Job Profile.xlsx"))
        df = pd.read_excel(url, engine='openpyxl')
        
        # Renomeia colunas para o padr√£o assumido (adapte se os nomes forem diferentes)
        df.columns = df.columns.str.upper().str.replace(' ', '_')
        
        # Colunas esperadas para o dashboard:
        COLUNAS_ESPERADAS = ['TITULO_CARGO', 'JOB_FAMILY', 'JOB_SUBFAMILY', 'GRADING', 'DIRETORIA']
        for col in COLUNAS_ESPERADAS:
            if col not in df.columns:
                # Cria colunas de simula√ß√£o se faltarem (apenas para o c√≥digo rodar)
                if col == 'TITULO_CARGO': df[col] = [f"Cargo_{i}" for i in range(len(df))]
                if col == 'JOB_FAMILY': df[col] = df.index % 4 + 1 # Simula 4 families
                if col == 'JOB_SUBFAMILY': df[col] = df.index % 8 + 1 # Simula 8 subfamilies
                if col == 'GRADING': df[col] = "L" + (df.index % 5 + 1).astype(str) # Simula 5 grades
                if col == 'DIRETORIA': df[col] = "D" + (df.index % 3 + 1).astype(str) # Simula 3 diretorias

        # Converte para string para evitar problemas de tipo em gr√°ficos
        df = df[COLUNAS_ESPERADAS].astype(str).drop_duplicates(subset='TITULO_CARGO')
        
        return df

    except Exception as e:
        st.error(f"Erro ao carregar o arquivo Job Profile.xlsx. Verifique se o nome do arquivo e a URL est√£o corretos. Detalhe: {e}")
        return pd.DataFrame()

df = load_data(FILE_URL)

if not df.empty:
    
    section("üéØ Dashboard de Arquitetura de Cargos")

    # --- 2. M√âTRICAS CHAVE (TOP KNOBS) ---
    col1, col2, col3, col4 = st.columns(4)
    
    with col1:
        st.metric(label="Total de Cargos √önicos", value=f"{df['TITULO_CARGO'].nunique():,}")
    
    with col2:
        st.metric(label="Total de Job Families", value=df['JOB_FAMILY'].nunique())

    with col3:
        st.metric(label="Total de Job Subfamilies", value=df['JOB_SUBFAMILY'].nunique())
    
    with col4:
        st.metric(label="Total de N√≠veis (Grading)", value=df['GRADING'].nunique())

    st.markdown("---")

    # --- 3. DASHBOARD: DISTRIBUI√á√ÉO POR FAM√çLIA e SUBFAM√çLIA ---
    st.subheader("1. Distribui√ß√£o por Job Family e Subfamily")
    
    col_family, col_subfamily = st.columns([1, 2])

    # Gr√°fico 1: Job Family
    family_counts = df.groupby('JOB_FAMILY')['TITULO_CARGO'].nunique().reset_index(name='Cargos')
    fig_family = px.pie(
        family_counts, 
        values='Cargos', 
        names='JOB_FAMILY', 
        title='Distribui√ß√£o por Job Family',
        color_discrete_sequence=px.colors.qualitative.Pastel # Identidade visual adapt√°vel
    )
    col_family.plotly_chart(fig_family, use_container_width=True)

    # Gr√°fico 2: Tabela de Subfamilies
    subfamily_counts = df.groupby(['JOB_FAMILY', 'JOB_SUBFAMILY'])['TITULO_CARGO'].nunique().reset_index(name='Cargos')
    subfamily_counts = subfamily_counts.sort_values(by='Cargos', ascending=False)
    
    col_subfamily.markdown("#### Detalhamento por Subfamily")
    col_subfamily.dataframe(
        subfamily_counts.rename(columns={'JOB_FAMILY': 'Fam√≠lia', 'JOB_SUBFAMILY': 'Subfam√≠lia'}),
        use_container_width=True,
        hide_index=True
    )
    st.markdown("---")

    # --- 4. DASHBOARD: DISTRIBUI√á√ÉO POR GRADING (N√çVEL) ---
    st.subheader("2. Distribui√ß√£o por Grading")

    grading_counts = df.groupby('GRADING')['TITULO_CARGO'].nunique().reset_index(name='Cargos')
    # Nota: Usamos 'GRADING' como categoria para garantir a ordem correta, se aplic√°vel
    fig_grading = px.bar(
        grading_counts, 
        x='GRADING', 
        y='Cargos', 
        text='Cargos',
        title='Contagem de Cargos por N√≠vel (Grading)',
        color='GRADING'
    )
    fig_grading.update_layout(xaxis={'categoryorder':'category ascending'}) # Tenta ordenar A, B, C ou L1, L2, L3
    st.plotly_chart(fig_grading, use_container_width=True)

    st.markdown("---")

    # --- 5. DASHBOARD: MATRIZ DIRETORIA x GRADING (SUGEST√ÉO IMPORTANTE) ---
    st.subheader("3. Heatmap: Distribui√ß√£o de Cargos por Diretoria e Grading")
    st.caption("Esta √© a vis√£o mais estrat√©gica: mostra onde est√£o os cargos de maior n√≠vel (maior 'Grading') dentro de cada Diretoria.")

    # Cria a tabela de conting√™ncia
    matrix = pd.crosstab(df['GRADING'], df['DIRETORIA'])
    
    # Cria o Heatmap (Mapa de Calor)
    fig_heatmap = px.imshow(
        matrix.values,
        x=matrix.columns,
        y=matrix.index,
        color_continuous_scale='Inferno_r', # Cores fortes para destaque estrat√©gico
        aspect="auto",
        text_auto=True
    )
    fig_heatmap.update_layout(
        title='Matriz: Grading vs. Diretoria (Contagem de Cargos)',
        yaxis_title="N√≠vel de Cargo (Grading)",
        xaxis_title="Diretoria / √Årea"
    )
    st.plotly_chart(fig_heatmap, use_container_width=True)


    # --- 6. O QUE MAIS SUGERIMOS (Sugest√£o Extra) ---
    st.markdown("---")
    st.subheader("üí° O Que Mais Sugerimos (M√©tricas de An√°lise)")
    
    st.write(
        "Para aprofundar a an√°lise da Arquitetura de Cargos, sugiro adicionar as seguintes m√©tricas baseadas na sua tabela:"
    )
    
    col_s1, col_s2 = st.columns(2)

    with col_s1:
        st.markdown(
            """
            * **M√©trica de Concentra√ß√£o (Lideran√ßa):**
                * Percentual de cargos classificados como "Gest√£o/Lideran√ßa" (se voc√™ tiver uma coluna indicando isso).
                * Isso ajuda a identificar se a estrutura est√° muito "flat" (horizontal) ou muito "tall" (verticalizada).
            * **M√©trica de Amplitude de Controle:**
                * Se a tabela incluir o cargo do *manager*, voc√™ pode calcular a m√©dia de cargos reportando a cada n√≠vel de lideran√ßa.
            """
        )
    with col_s2:
        st.markdown(
            """
            * **M√©trica de Equidade (Homogeneidade do Grading):**
                * Percentual de cargos dentro de uma **mesma Job Family** que caem em *Gradings* adjacentes (ex: se 80% dos Analistas Pleno em Finan√ßas est√£o nos Grades L5 e L6, a equidade est√° alta).
            * **Tabela de Desvios Salariais (Se tiver dados de remunera√ß√£o):**
                * Exibir a m√©dia salarial por *Grading* e identificar cargos que est√£o abaixo ou acima da m√©dia da banda. **(Crucial para Remunera√ß√£o)**
            """
        )

else:
    st.warning("N√£o foi poss√≠vel gerar o dashboard pois os dados n√£o foram carregados.")
